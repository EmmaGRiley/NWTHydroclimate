# Snow Package

A comprehensive R package for analyzing snow water equivalent (SWE) data from manual snow surveys and ERA5-Land reanalysis data. This package provides tools for trend analysis using Mann-Kendall tests, autocorrelation detection, spatial mapping, and comparison between observational and reanalysis datasets.

## Overview

This package is designed for analysis of snow survey data in the Northwest Territories, Canada. It includes:

- **CanSWE Data Processing**: Functions to process and filter Canadian Snow Water Equivalent (CanSWE) dataset
- **ERA5-Land Analysis**: Tools for analyzing ERA5-Land reanalysis snow data
- **Trend Analysis**: Mann-Kendall and modified Mann-Kendall trend tests with autocorrelation detection
- **Spatial Mapping**: Interactive Leaflet maps for visualizing snow trends
- **Data Comparison**: Functions to compare manual survey data with ERA5-Land reanalysis

## Installation

### Prerequisites

This package requires R (>= 4.0.0) and several dependencies. Some dependencies may require additional setup:

- **KrigR**: For downloading ERA5-Land data. Install from GitHub:
  ```r
  # Install KrigR dependencies first
  install.packages(c("ecmwfr", "ncdf4", "automap", "foreach", "doSNOW", "pbapply", "cowplot"))
  # Then install KrigR from GitHub
  devtools::install_github("ErikKusch/KrigR")
  ```

- **PhantomJS**: Required for saving Leaflet maps as images. Install using:
  ```r
  webshot::install_phantomjs()
  ```

### Install the Package

```r
# Install from GitHub (once repository is available)
devtools::install_github("EmmaGRiley/snow")

# Or install from local directory
devtools::install("EmmaGRiley/snow")
```

## Package Structure

### Core Functions

The package is organized into several modules:

- **`ERA5_snowtrends_map_hourly_functions.R`**: Core functions for autocorrelation testing and trend analysis
- **`CanSWE_processing_V7.R`**: CanSWE data processing script

### Analysis Scripts

The following scripts are provided for specific analyses but may require user-specific data paths:

- **`ERA5_snowtrends_map_hourly.R`**: Main script for ERA5-Land trend analysis and mapping
- **`ERA5_snowcomparison_ER.R`**: Comparison between ERA5-Land and manual survey trends
- **`ERA5_snow_mapping.R`**: ERA5 snow mapping visualization
- **`ERA5_spring_snow_analysis.R`**: Spring snow depth analysis using ERA5-Land data
- **`SWE_adjust_extra_depths.R`**: Adjustment of SWE values using extra depth measurements
- **`SWE_summary.R`**: Summary statistics and visualization functions

## Data Requirements

### Package Data

The package includes sample data in the `data/` directory:

- `CanSWE_v7.csv`: Processed CanSWE data
- `missingBCdata.csv`: Missing British Columbia data supplement for 2015 march/april surveys
- NWT Manual snow survey data:
  - For GNWT network users: Scripts reference `R_Oracle_Connect.R` (not included in package)
  - For non-GNWT users: `md_3.rds`, `sites.rds`, `snow.rds` and `depths.rds` 
- `adjusted_swe_values.csv`: Adjusted SWE values for treeline sites
- `MRB_snowsurvey_trends.csv`: Mackenzie River Basin snow survey trends
- Various autocorrelation and trend result files that can be generated by the scripts or brought in from this directory

In the nested Shapefiles/ directory:

 - `MackenzieRiverBasin_FDA.shp` (Mackenzie River basin shapefile)
 - `NWT_ENR_BND_FND.shp` (NWT boundary)

In the nested SWEmax_dataset/directory:

- Spring maximum snow depth data (generated by `ERA5_spring_snow_analysis.R`)

### External Data

- `CanSWE-CanEEN_1928-2024_v7.csv`: CanSWE dataset (download from [Zenodo](https://zenodo.org/records/14901399))
  
## Key Functions

### Autocorrelation Testing

- `serial_autocorr_test()`: Test for serial autocorrelation in manual survey data
- `serial_autocorr_test_canswe()`: Test for serial autocorrelation in CanSWE data
- `interpret_acf()`: Interpret autocorrelation results
- `interpret_acf_canswe()`: Interpret CanSWE autocorrelation results

### Trend Analysis

- `p.value.function()`: Determine plotting style based on p-values
- `sen()`: Sen slope calculation wrapper

### Utility Functions

- `%!in%`: Negate %in% operator
- `appendvar()`: Variable matching utility

### Recommendations

**Before Running Scripts**: 
   - Check that all required data files exist
   - Update file paths to match your system
   - Ensure external dependencies (shapefiles, ERA5 data, CanSWE data) are available

## Dependencies

### Required Packages

- `dplyr`: Data manipulation
- `magrittr`: Pipe operator
- `lubridate`: Date handling
- `sf`: Spatial data handling
- `leaflet`: Interactive mapping
- `ggplot2`: Plotting
- `Kendall`: Mann-Kendall test
- `trend`: Trend analysis
- `modifiedmk`: Modified Mann-Kendall test
- `purrr`: Functional programming
- `stringr`: String manipulation
- `tidyr`: Data tidying
- `htmlwidgets`: HTML widgets
- `webshot`: Web page screenshots
- `terra`: Raster data handling
- `sp`: Spatial data classes

### Suggested Packages

- `KrigR`: ERA5-Land data download
- `spearmanCI`: Spearman correlation confidence intervals
- `mblm`: Median-based linear models
- `data.table`: Fast data manipulation

## Citation

If you use this package in your research, please cite:

```
Gregory, E. (2026). snow: Snow Water Equivalent Analysis and Trend Detection. 
R package version 0.1.0.
```

## License

MIT License - see LICENSE file for details

## Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Submit a pull request

## Support

For issues, questions, or contributions, please open an issue on the GitHub repository.

## Acknowledgments

- CanSWE dataset: [Zenodo](https://zenodo.org/records/14901399)
- ERA5-Land reanalysis data: Copernicus Climate Change Service
- Government of Northwest Territories, Department of Environment and Climate Change for snow survey data

## Version History

- **0.1.0** (2026): Initial package release
  - Core functions for trend analysis
  - CanSWE data processing
  - ERA5-Land analysis tools
  - Spatial mapping capabilities

